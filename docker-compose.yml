version: '3.8'
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatsapp-ai-app
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3000}
      PG_DATABASE_URL: ${PG_DATABASE_URL}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}
      GOOGLE_SHEET_ID: ${GOOGLE_SHEET_ID}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      Token: ${Token}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      EMPLOYEE_EMAIL: ${EMPLOYEE_EMAIL}
      WHATSAPP_TOKEN: ${WHATSAPP_TOKEN}
      WHATSAPP_PHONE_NUMBER_ID: ${WHATSAPP_PHONE_NUMBER_ID}
      WHATSAPP_BUSINESS_ACCOUNT_ID: ${WHATSAPP_BUSINESS_ACCOUNT_ID}
      WHATSAPP_URL: ${WHATSAPP_URL}
      WHATSAPP_TO_NUMBER: ${WHATSAPP_TO_NUMBER}
      WHATSAPP_WEBHOOK_VERIFY_TOKEN: ${WHATSAPP_WEBHOOK_VERIFY_TOKEN}
      SHEETS_WEBHOOK_TOKEN: ${SHEETS_WEBHOOK_TOKEN}
      FLW_SECRET_KEY: ${FLW_SECRET_KEY}
      FLW_WEBHOOK_SECRET: ${FLW_WEBHOOK_SECRET}
      DEPOSIT_AMOUNT: ${DEPOSIT_AMOUNT}
      CURRENCY: ${CURRENCY}
      ZOHO_CLIENT_ID: ${ZOHO_CLIENT_ID}
      ZOHO_CLIENT_SECRET: ${ZOHO_CLIENT_SECRET}
      ZOHO_REDIRECT_URI: ${ZOHO_REDIRECT_URI}
      ZOHO_REFRESH_TOKEN: ${ZOHO_REFRESH_TOKEN}
      DEPLOYED_URL: ${DEPLOYED_URL}
    networks:
      - whatsapp-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: sh -c "npx sequelize-cli db:migrate && node app.js"

networks:
  whatsapp-network:
    driver: bridge